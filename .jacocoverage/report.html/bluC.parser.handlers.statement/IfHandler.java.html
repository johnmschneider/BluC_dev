<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>IfHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;BluC&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">bluC.parser.handlers.statement</a> &gt; <span class="el_source">IfHandler.java</span></div><h1>IfHandler.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2021 John Schneider.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package bluC.parser.handlers.statement;

import bluC.Logger;
import bluC.transpiler.Expression;
import bluC.transpiler.Scope;
import bluC.transpiler.Statement;
import bluC.transpiler.Statement.If.Else;
import bluC.transpiler.Statement.If.ElseIf;
import bluC.transpiler.Token;
import bluC.transpiler.TokenFileInfo;
import bluC.transpiler.TokenInfo;
import bluC.parser.Parser;
import bluC.parser.handlers.expression.ExpressionHandler;

/**
 *
 * @author John Schneider
 */
public class IfHandler
{
    private final Parser parser;
    private final BlockHandler blockHandler;
    private final ExpressionHandler expressionHandler;
    
    public IfHandler(Parser parser, BlockHandler blockHandler,
        ExpressionHandler expressionHandler)
<span class="fc" id="L43">    {</span>
<span class="fc" id="L44">        this.parser = parser;</span>
<span class="fc" id="L45">        this.blockHandler = blockHandler;</span>
<span class="fc" id="L46">        this.expressionHandler = expressionHandler;</span>
<span class="fc" id="L47">    }</span>
    
    
    public Statement handleIfStatement(Token potentialIf)
    {
        Token openParen;
            
<span class="nc" id="L54">        parser.nextToken();</span>
<span class="nc" id="L55">        openParen = parser.peek();</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (openParen.getTextContent().equals(&quot;(&quot;))</span>
        {
<span class="nc" id="L59">            return handleOpenParenthesisAndCondition(openParen, </span>
                potentialIf);
        }
        else
        {
<span class="nc" id="L64">            return handleInvalidIfCondition(openParen,</span>
                potentialIf);
        }
    }
    
    private Statement handleOpenParenthesisAndCondition(Token openParen,
        Token potentialIf)
    {
<span class="nc" id="L72">        Statement.If statement = newIfWithCondition(openParen);</span>
<span class="nc" id="L73">        Token closeParen = parser.peek();</span>
        
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (closeParen.getTextContent().equals(&quot;)&quot;))</span>
        {
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (doesIfOrElseIfHaveEmptyBody())</span>
            {
                //consume )
<span class="nc" id="L80">                parser.nextToken();</span>
                
                //consume {
<span class="nc" id="L83">                parser.nextToken();</span>
                
                //} is consumed by handleStatement
            }
            else
            {
<span class="nc" id="L89">                handleBody(statement, getOpenBrace());</span>
            }
        }
        else
        {
<span class="nc" id="L94">            Logger.err(closeParen, &quot;Expected \&quot;)\&quot; to close &quot; +</span>
                &quot;condition of if statement at line &quot; + 
<span class="nc" id="L96">                (potentialIf.getLineIndex() + 1));</span>
        }
        
<span class="nc" id="L99">        handleElseIfs(statement);</span>
        
<span class="nc" id="L101">        return statement;</span>
    }
    
    private boolean doesIfOrElseIfHaveEmptyBody()
    {
<span class="nc" id="L106">        return parser.peekMatches(3, &quot;}&quot;);</span>
    }
    
    private Statement.If newIfWithCondition(Token openParen)
    {
        Expression condition;
        
        //consume &quot;(&quot;        
<span class="nc" id="L114">        parser.nextToken();</span>
<span class="nc" id="L115">        condition = expressionHandler.handleExpression();</span>
        
<span class="nc" id="L117">        return new Statement.If(condition, openParen.getLineIndex());</span>
    }
    
    private void handleBody(Statement.Block statement, Token openBrace)
    {
        //consume &quot;)&quot; and set curToken == &quot;{&quot;
<span class="nc" id="L123">        parser.nextToken();</span>

<span class="nc" id="L125">        parser.pushScope(new Scope(parser.getCurrentScope(), statement));</span>
<span class="nc" id="L126">        blockHandler.addStatementsToBlock(openBrace, statement);</span>
<span class="nc" id="L127">        parser.popScope(parser.peek());</span>
<span class="nc" id="L128">    }</span>
    
    private Token getOpenBrace()
    {
        Token openBrace;
            
<span class="nc" id="L134">        parser.nextToken();</span>
<span class="nc" id="L135">        openBrace = parser.peek();</span>
        
<span class="nc" id="L137">        return openBrace;</span>
    }
    
    private Statement handleInvalidIfCondition(Token openParen, 
        Token potentialIf)
    {
        Token fakeOpenParen;
        
<span class="nc" id="L145">        Logger.err(openParen, &quot;Expected \&quot;(\&quot; to open condition of &quot; + </span>
<span class="nc" id="L146">                &quot;if statement at line &quot; + (potentialIf.getLineIndex() + 1));</span>
        
<span class="nc" id="L148">        fakeOpenParen = new Token(</span>
            new TokenInfo(&quot;(&quot;, true),
                
<span class="nc" id="L151">            new TokenFileInfo(openParen.getFilepath(), </span>
<span class="nc" id="L152">                openParen.getLineIndex()));</span>
        
<span class="nc" id="L154">        parser.addToken(fakeOpenParen, parser.indexOf(openParen));</span>
        
<span class="nc" id="L156">        return handleOpenParenthesisAndCondition(fakeOpenParen, </span>
            potentialIf);
    }
    
    private void handleElseIfs(Statement.If statement)
    {
        Token else_;
        
<span class="nc bnc" id="L164" title="All 2 branches missed.">        while (!parser.atEOF())</span>
        {
<span class="nc" id="L166">            parser.nextToken();</span>
<span class="nc" id="L167">            else_ = parser.peek();</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (else_.getTextContent().equals(&quot;else&quot;))</span>
            {
<span class="nc" id="L171">                handleElseIfCheck(statement, else_);</span>
            }
            else
            {
<span class="nc" id="L175">                parser.prevToken();</span>
<span class="nc" id="L176">                break;</span>
            }
        }
<span class="nc" id="L179">    }</span>
    
    private void handleElseIfCheck(Statement.If statement, Token else_)
    {
        Token ifOrOpenBrace;
        String ifOrOpenBraceText;

<span class="nc" id="L186">        parser.nextToken();</span>
<span class="nc" id="L187">        ifOrOpenBrace = parser.peek();</span>
<span class="nc" id="L188">        ifOrOpenBraceText = ifOrOpenBrace.getTextContent();</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (ifOrOpenBraceText.equals(&quot;if&quot;))</span>
        {
<span class="nc" id="L192">            parser.nextToken();</span>
<span class="nc" id="L193">            handleElseIf(statement, ifOrOpenBrace);</span>
        }
<span class="nc bnc" id="L195" title="All 2 branches missed.">        else if (ifOrOpenBraceText.equals(&quot;{&quot;))</span>
        {
<span class="nc" id="L197">            handleElse(statement, ifOrOpenBrace);</span>
        }
        else
        {
<span class="nc" id="L201">            Logger.err(ifOrOpenBrace, &quot;Expected \&quot;if\&quot; or \&quot;{\&quot; to &quot; +</span>
<span class="nc" id="L202">                &quot;follow \&quot;&quot; + else_.getTextContent() + &quot; on line &quot; + </span>
<span class="nc" id="L203">                 (else_.getLineIndex() + 1));</span>
        }
<span class="nc" id="L205">    }</span>
    
    private void handleElseIf(Statement.If statement, Token ifOfTheElse)
    {
<span class="nc" id="L209">        Token openParen = parser.peek();</span>
<span class="nc" id="L210">        String openParenText = openParen.getTextContent();</span>
        
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (openParenText.equals(&quot;(&quot;))</span>
        {
<span class="nc" id="L214">            handleValidatedElseIf(statement, ifOfTheElse, openParen);</span>
        }
        else
        {
<span class="nc" id="L218">            handleElseIfNoOpenParenthesis(statement, ifOfTheElse, openParen);</span>
        }
<span class="nc" id="L220">    }</span>
    
    private void handleValidatedElseIf(Statement.If statement, 
        Token ifOfTheElse, Token openParen)
    {
        Expression condition;
        Token closeParen;
        String closeParenText;
        
<span class="nc" id="L229">        parser.nextToken();</span>
<span class="nc" id="L230">        condition = expressionHandler.handleExpression();</span>
        
<span class="nc" id="L232">        closeParen = parser.peek();</span>
<span class="nc" id="L233">        closeParenText = closeParen.getTextContent();</span>
        
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (closeParenText.equals(&quot;)&quot;))</span>
        {
<span class="nc" id="L237">            ElseIf elseIf = new ElseIf(condition, openParen.getLineIndex());</span>
            
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if (doesIfOrElseIfHaveEmptyBody())</span>
            {
                //consume )
<span class="nc" id="L242">                parser.nextToken();</span>
                
                //consume {
<span class="nc" id="L245">                parser.nextToken();</span>
                
                //} is consumed by handleStatement
            }
            else
            {
<span class="nc" id="L251">                handleBody(elseIf, getOpenBrace());</span>
            }
            
<span class="nc" id="L254">            statement.addElseIf(elseIf);</span>
<span class="nc" id="L255">        }</span>
        else
        {
<span class="nc" id="L258">            Logger.err(closeParen, &quot;Expected \&quot;)\&quot; to close &quot; +</span>
                &quot;condition of else-if statement at line &quot; + 
<span class="nc" id="L260">                (ifOfTheElse.getLineIndex() + 1));</span>
        }
<span class="nc" id="L262">    }</span>
    
    
    private void handleElseIfNoOpenParenthesis(Statement.If statement,
        Token ifOfTheElse, Token expectedOpenParen)
    {
        Token fakeOpenParen;
        
<span class="nc" id="L270">        Logger.err(expectedOpenParen, &quot;Expected \&quot;(\&quot; to open condition of &quot; + </span>
            &quot;else-if statement at line &quot; + 
<span class="nc" id="L272">            (ifOfTheElse.getLineIndex() + 1));</span>
        
<span class="nc" id="L274">        fakeOpenParen = new Token(</span>
            new TokenInfo(&quot;(&quot;, true), 
                
<span class="nc" id="L277">            new TokenFileInfo(expectedOpenParen.getFilepath(), </span>
<span class="nc" id="L278">                expectedOpenParen.getLineIndex()));</span>
        
<span class="nc" id="L280">        parser.addToken(fakeOpenParen, parser.indexOf(expectedOpenParen));</span>
        
<span class="nc" id="L282">        handleValidatedElseIf(statement, ifOfTheElse, expectedOpenParen);</span>
<span class="nc" id="L283">    }</span>
    
    private void handleElse(Statement.If statement, Token openBrace)
    {
<span class="nc" id="L287">        Else elseStatement = new Else(openBrace.getLineIndex());</span>
        
<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (doesElseHaveEmptyBody())</span>
        {
            //consume {
<span class="nc" id="L292">            parser.nextToken();</span>
            
            //} is consumed by handleStatement
        }
        else
        {
<span class="nc" id="L298">            handleBody(elseStatement, openBrace);</span>
        }
        
<span class="nc" id="L301">        statement.setElse(elseStatement);</span>
<span class="nc" id="L302">    }</span>
    
    private boolean doesElseHaveEmptyBody()
    {
<span class="nc" id="L306">        return parser.peekMatches(2, &quot;}&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>